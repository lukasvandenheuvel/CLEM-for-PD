rescale = 0.2;
save_rescaled = true;

//folder_array = newArray("/Volumes/Lukas_1T/PDM/Data/LH02_A03/block1/cycle10_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block1/cycle11_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block1/cycle11_ROI3/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block1/cycle13_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block1/cycle15_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block1/cycle16_ROI2/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block1/cycle16_ROI3/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block1/cycle17_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block1/cycle17_ROI3/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block2/cycle12_ROI2/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block2/cycle12_ROI6/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block2/cycle13_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block2/cycle13_ROI4/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block2/cycle14_ROI1/",
						
//folder_array = newArray("/Volumes/Lukas_1T/PDM/Data/LH02_A03/block2/cycle14_ROI2/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_Amanda_A02_b1/cycle12_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_Amanda_A02_b1/cycle13_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_Amanda_A02_b1/cycle14_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_Amanda_A02_b1/cycle12_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_Amanda_A02_b1/cycle13_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_Amanda_A02_b1/cycle14_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A04/block1/cycle4_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A04/block1/cycle4_ROI2/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A04/block1/cycle4_ROI3/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A04/block1/cycle5_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A04/block1/cycle5_ROI2/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A04/block1/cycle4_ROI1/",
//folder_array = newArray("/Volumes/Lukas_1T/PDM/Data/LH02_A04/block1/cycle4_ROI3/");
//folder_array = newArray("/Volumes/Lukas_1T/PDM/Data/LH02_A04/block1/cycle5_ROI2/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block1/cycle7_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block1/cycle7_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block1/cycle9_ROI1/",
//						"/Volumes/Lukas_1T/PDM/Data/LH02_A03/block1/cycle9_ROI1/");
//folder_array = newArray("/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH01_A02/Block1/cycle6_ROI1/",
//						"/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH01_A02/Block1/cycle7_ROI1/",
//folder_array = newArray("/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH01_A02/Block2/cycle11_ROI1/",
//						"/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH01_A02/Block2/cycle12_ROI1/",
//						"/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH01_A05/Block1/cycle8_ROI1/",
//						"/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH01_A05/Block1/cycle9_ROI1/",
//						"/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH01_A05/Block1/cycle10_ROI1/",
//						"/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH01_A05/Block1/cycle11_ROI1/",
//						"/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH01_A05/Block2/cycle5_ROI1/",
//						"/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH01_A05/Block3/cycle12_ROI1/",
//						"/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH01_A05/Block3/cycle13_ROI1/");
						
//folder_array = newArray("/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH02_A03/block2/cycle6_ROI1/",
//						"/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH02_A03/block2/cycle12_ROI3/",
//						"/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH02_A03/block2/cycle13_ROI1/",
//folder_array = newArray("/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH02_A03/block1/cycle9_ROI1/");
folder_array = newArray("/Users/lukasvandenheuvel/Documents/EPFL/MA4/PDM/Data/LH02_A03/block2/cycle14_ROI1/");

//to_warp_array = newArray("thunder_S003_z61.tif",
//						 "thunder_S006_z24.tif",
//						 "thunder_S003_z66.tif",
//						 "thunder_S006_z38.tif",
//						 "thunder_S006_z53.tif",
//						 "thunder_S006_z60.tif",
//						 "thunder_S001_z64.tif",
//						 "thunder_S001_z73.tif",
//						 "thunder_S006_z69.tif",
//						 "thunder_s010_z27.tif",
//						 "thunder_s003_z53.tif",
//						 "thunder_s001_z45.tif",
//						 "thunder_s014_z19.tif",
//						 "thunder_s001_z53.tif",
						 
//to_warp_array = newArray("thunder_s002_z49.tif",
//						 "IHC.tif",
//						 "IHC.tif",
//						 "IHC.tif",
//						 "thunder_s017_z31.tif",
//						 "thunder_s017_z25.tif",
//						 "thunder_s017_z12.tif",
//						 "IHC.tif",
//						 "IHC.tif",
//						 "IHC.tif",
//						 "IHC.tif",
//						 "IHC.tif",
//						 "thunder_s005_z32.tif",
//to_warp_array = newArray("thunder_s001_z64.tif");
//to_warp_array = newArray("thunder_s001_z77.tif",
//						 "thunder_S003_z15.tif",
//						 "IHC.tif",
//						 "thunder_S003_z37.tif",
//						 "IHC.tif");
//to_warp_array = newArray("thunder_s001_z33.tif",
//					     "thunder_s001_z24.tif",
//to_warp_array = newArray("thunder_s004_z11.tif",
//					     "thunder_s004_z19.tif",
//					     "thunder_s013_z61.tif",
//					     "thunder_s013_z50.tif",
//					     "thunder_s013_z38.tif",
//					     "thunder_s013_z18.tif",
//					     "thunder_s018_z17.tif",
//					     "thunder_s023_z16.tif",
//					     "thunder_s023_z11.tif");
//to_warp_array = newArray("thunder_s006_z15.tif",
//						 "thunder_s008_z39.tif",
//						 "thunder_s001_z45.tif",
to_warp_array = newArray("thunder_s001_z53.tif");
//folder = "/Volumes/Lukas_1T/PDM/Data/LH02_A03/block1/cycle11_ROI3/"; // Make sure path ends with '/'
//to_warp_name = "thunder_S003_z66.tif";

s = File.separator();
//setBatchMode(true);

for (i = 0; i < folder_array.length; i++) {
	run("Close All");
	run("Collect Garbage");
	print("Cleared memory");
	folder = folder_array[i];
	to_warp_name = to_warp_array[i];
	
	
	to_warp_path = folder + to_warp_name;
	hmEM_path = folder + "hmEM.tif";
	out_path = folder;
	landmarks_file = folder + "landmarks_lmEM_to_hmEM.csv";
	to_warp = File.getNameWithoutExtension(to_warp_path);
	File.setDefaultDir(folder); // Set default directory to folder
	
	print(out_path+s+"warp_"+to_warp+"_to_lmEM.tif");
	
	// Apply transform
	print("Transforming "+to_warp_name+" using the lmEM-to-hmEM transform ...");
	run("Apply Bigwarp Xfm", "landmarkspath="+landmarks_file+" movingpath="+out_path+s+"warp_"+to_warp+"_to_lmEM.tif targetpath=["+hmEM_path+"] transformtype=[Thin Plate Spline] interptype=Linear nthreads=1 isvirtual=false");
	
	// Save transformed IHC
	selectWindow("warp_"+to_warp+"_to_lmEM.tif channel 1_warp_"+to_warp+"_to_lmEM.tif channel 1_xfm_0");
	rename("warp_"+to_warp+"_to_hmEM");
	saveAs("Tiff", out_path + s + "warp_"+to_warp+"_to_hmEM.tif");
	
	if (save_rescaled){
		// Rescale transformed IHC
		getDimensions(width, height, channels, slices, frames);
		print("Number channels = "+d2s(channels,0));
		new_width = round(rescale*width);
		new_height = round(rescale*height);
		
		print("Downsizing warp-to-hmEM ...");
		//run("Set Scale...", "distance=1 known="+d2s(pixel_size_um,6)+" unit=um");
		//run("Scale...", "x="+d2s(rescale,1)+" y="+d2s(rescale,1)+" width="+d2s(new_width,0)+" height="+d2s(new_height,0)+" interpolation=Bicubic average create process");
		run("Size...", "width="+d2s(new_width,0)+" height="+d2s(new_height,0)+" depth="+d2s(channels,0)+" constrain average interpolation=Bilinear");
		saveAs("Tiff", out_path + s + "warp_"+to_warp+"_to_hmEM_small.tif");
		close("warp_"+to_warp+"_to_hmEM.tif");
	}
	print("Saved "+out_path + s + "warp_"+to_warp+"_to_hmEM.tif");
}
print("All is done!");